@startuml
allowmixing
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam ArrowThickness 1

' ===== ã‚¹ãƒ†ãƒ¬ã‚ªã‚¿ã‚¤ãƒ—åˆ¥ã®èƒŒæ™¯è‰² =====
skinparam component {
  BackgroundColor<<Loop>> #AAFFAA
  BackgroundColor<<Init>> #DDDDDD
  BackgroundColor<<HW>> #F5E1FF
}

' ===== å‡¡ä¾‹ =====
legend left
  âš« é»’: ã‚¢ãƒ—ãƒªèµ·å‹•ãƒ»åˆæœŸåŒ–
  ğŸŸ  æ©™: ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡
  ğŸŸ© ç·‘: DMAãƒ»ãƒãƒƒãƒ•ã‚¡å‡¦ç†
  ğŸ”µ é’: ISPãƒ»AEWBå‡¦ç†
  ğŸŸ¡ é»„: è¡¨ç¤ºãƒ»ãƒ•ã‚§ãƒ³ã‚¹åŒæœŸ
  ğŸ“˜ é’: è¨­å®šå‚ç…§
  ğŸŸ£ ç´«: HWã‹ã‚‰ã®é€šçŸ¥ãƒ»åˆ¶å¾¡
  L_* / <<Loop>> : ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆç¶™ç¶šï¼‰
  C_* / <<Init>> : åˆæœŸåŒ–å‡¦ç†ï¼ˆå˜ç™ºï¼‰
  HW_* / <<HW>> : ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
  å®Ÿç·š: åŒæœŸå‡¦ç†
  ç‚¹ç·š: ã‚¹ãƒ¬ãƒƒãƒ‰é–“éåŒæœŸ
endlegend

' ===== HWãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« =====
package "Hardware" {
  component HW_CSI_RX <<HW>>
  component HW_DMA_ENGINE <<HW>>
  note right of HW_DMA_ENGINE
    ã‚»ãƒ³ã‚µãƒ¼ã‹ã‚‰ã®æ˜ åƒä¿¡å·ã‚’å—ä¿¡ã—ã€\nC_dma_c ã«é€šçŸ¥ã‚’è¡Œã†
  end note
}

' ===== AppConfig ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« =====
package "AppConfig" {
  component C_AppConfig <<Init>>
  note right of C_AppConfig
    è¨­å®šé …ç›®:
    - ã‚»ãƒ³ã‚µãƒ¼æ•°ãƒ»ç¨®é¡
    - è§£åƒåº¦ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ
    - è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    - VISS / AEWB æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    - å‡ºåŠ›å½¢å¼ãƒ»ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
    - NFSãƒ‘ã‚¹ãƒ»ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º
  end note
}

' ===== ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾© =====
package "Main Entry" {
  component C_main_linux_arm_c <<Init>>
}

package "Application Core" {
  component C_app_main_c <<Init>>
  component C_config_c <<Init>>
  component C_threads_c <<Init>>

  note right of C_config_c
    app_parse_cmd_line_args() ã«ã‚ˆã‚Š AppConfig ã‚’æ§‹ç¯‰
  end note
}

package "Sensor Layer" {
  component L_sensor_mgr_c <<Loop>>
  component C_sensor_hal_c <<Init>>
}

package "Buffer & DMA" {
  component C_buffer_mgr_c <<Init>>
  component C_dma_c <<Init>>
  component C_raw_buf_c <<Init>>
}

package "Image Processing" {
  component C_ics_c <<Init>>
  component C_aewb_c <<Init>>
}

package "Display System" {
  component C_msc_c <<Init>>
  component C_display_c <<Init>>
  component C_layout_mgr_c <<Init>>
}

package "UI Layer" {
  component C_event_dispatch_c <<Init>>
}

package "Threads" {
  component L_main_loop_thread <<Loop>>
  component L_sensor_thread <<Loop>>
  component L_isp_thread <<Loop>>
  component L_display_thread <<Loop>>
}

package "Graph Builder" {
  component C_app_cfg_c <<Init>>
}

package "Sensor Control" {
  component C_app_sensor_c <<Init>>
}

package "Display Layout" {
  component C_app_layout_c <<Init>>
}

' ===== AppConfig å‚ç…§é–¢ä¿‚ï¼ˆğŸ“˜ï¼‰=====
C_AppConfig -[#blue]-> C_config_c
C_AppConfig -[#blue]-> C_app_main_c
C_AppConfig -[#blue]-> C_app_cfg_c
C_AppConfig -[#blue]-> C_app_sensor_c
C_AppConfig -[#blue]-> C_app_layout_c

' ===== HWé€šçŸ¥é–¢ä¿‚ï¼ˆğŸŸ£ï¼‰=====
HW_CSI_RX -[#purple]-> HW_DMA_ENGINE : CSIä¿¡å·å…¥åŠ›
HW_DMA_ENGINE -[#purple]-> C_dma_c : ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿é€šçŸ¥ï¼ˆå‰²ã‚Šè¾¼ã¿ï¼‰

' ===== èµ·å‹•ãƒ»åˆæœŸåŒ– =====
C_main_linux_arm_c -[#black]-> C_app_main_c : â‘  <b><color:red>[Main]</color></b> app_multi_cam_main()\nã‚¢ãƒ—ãƒªèµ·å‹•ãƒ»åˆæœŸåŒ–é–‹å§‹
C_app_main_c -[#black]-> C_config_c : â‘¡ <b><color:red>[Main]</color></b> app_parse_cmd_line_args()\nè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«/CLIã‹ã‚‰AppConfigç”Ÿæˆ
C_app_main_c -[#black]-> C_threads_c : â‘¢ <b><color:red>[Main]</color></b> create_threads()\nå„ç¨®ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆ
C_app_main_c -[#black]-> L_sensor_mgr_c : â‘£ <b><color:red>[Main]</color></b> app_init()\nã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–
C_app_main_c -[#black]-> C_buffer_mgr_c : â‘¤ <b><color:red>[Main]</color></b> alloc_buffers()\nDMAãƒãƒƒãƒ•ã‚¡å‰²å½“

' ===== ã‚­ãƒ£ãƒ—ãƒãƒ£è¦æ±‚ =====
L_main_loop_thread -[#orange]-> L_sensor_mgr_c : â‘¥ <b><color:red>[MainLoop]</color></b> capture_enqueue_request()\nã‚­ãƒ£ãƒ—ãƒãƒ£è¦æ±‚ã‚­ãƒ¥ãƒ¼æŠ•å…¥

' ===== DMAé€ä¿¡ =====
L_sensor_mgr_c -[#green]-> C_sensor_hal_c : â‘¦ <b><color:red>[SensorThread]</color></b> sensor_submit_capture()\nã‚»ãƒ³ã‚µãƒ¼ã«DMAè¦æ±‚
C_sensor_hal_c -[#green]-> C_dma_c : â‘§ <b><color:red>[SensorThread]</color></b> dma_submit()\nDMAã‚¨ãƒ³ã‚¸ãƒ³ã«ãƒãƒƒãƒ•ã‚¡ç™»éŒ²

' ===== DMAå®Œäº†é€šçŸ¥ï¼ˆéåŒæœŸï¼‰=====
C_dma_c ..[#green]-> C_raw_buf_c : â‘¨ <b><color:red>[DMA IRQ]</color></b> dma_complete_callback()\nå®Œäº†ãƒãƒƒãƒ•ã‚¡ã‚’rawbufã«é€šçŸ¥
C_raw_buf_c ..[#green]-> C_event_dispatch_c : â‘© <b><color:red>[DMA IRQ]</color></b> notify_frame_ready()\nãƒ•ãƒ¬ãƒ¼ãƒ åˆ°ç€é€šçŸ¥

' ===== ISPå‡¦ç†ï¼ˆéåŒæœŸï¼‰=====
C_event_dispatch_c ..[#blue]-> L_isp_thread : â‘ª <b><color:red>[ISPThread]</color></b> viss_process_frame()\nISPå‡¦ç†é–‹å§‹
L_isp_thread -[#blue]-> C_raw_buf_c : â‘« <b><color:red>[ISPThread]</color></b> rawbuf_acquire()\nãƒãƒƒãƒ•ã‚¡æ‰€æœ‰æ¨©å–å¾—
L_isp_thread -[#blue]-> C_aewb_c : â‘¬ <b><color:red>[ISPThread]</color></b> AEWB_compute_stats()\nçµ±è¨ˆè¨ˆç®—ã¨éœ²å‡ºæ±ºå®š
C_aewb_c -[#orange]-> C_sensor_hal_c : â‘­ <b><color:red>[ISPThread]</color></b> apply_sensor_exposure()\néœ²å‡º/ã‚²ã‚¤ãƒ³åæ˜ 

' ===== ISPå‡ºåŠ› â†’ è¡¨ç¤º =====
L_isp_thread -[#blue]-> C_ics_c : â‘® <b><color:red>[ISPThread]</color></b> processed_image_handle()\nISPå‡ºåŠ›ãƒãƒƒãƒ•ã‚¡æ¸¡ã—
C_ics_c -[#yellow]-> C_msc_c : â‘¯ <b><color:red>[ISPThread]</color></b> msc_acquire_buffer()\nã‚¹ã‚±ãƒ¼ãƒ©ã«ãƒãƒƒãƒ•ã‚¡æ¸¡ã—
C_msc_c -[#yellow]-> C_layout_mgr_c : â‘° <b><color:red>[ISPThread]</color></b> appGetWindowConfig()\nã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ§‹æˆå–å¾—
C_msc_c -[#yellow]-> C_display_c : â‘± <b><color:red>[ISPThread]</color></b> display_blit()\nè¡¨ç¤ºè¦æ±‚
C_display_c -[#yellow]-> C_display_c : â‘² <b><color:red>[DisplayThread]</color></b> display_wait_fence()\nVSYNCå¾…ã¡
C_display_c -[#yellow]-> C_raw_buf_c : â‘³ <b><color:red>[DisplayThread]</color></b> display_release()\nãƒãƒƒãƒ•ã‚¡è§£æ”¾
@enduml